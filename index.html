<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conferência do Prontos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Variáveis CSS para o tema padrão (inicial) */
        :root {
            --primary-color: #000000;
            --primary-dark-color: #333333;
            --secondary-color: #FFD700;
            --secondary-dark-color: #CCAA00;
            --accent-color: #DC3545;
            --text-color: #333;
            --light-text-color: #ffffff;
            --background-color: #f0f0f0;
            --card-background: #ffffff;
            --border-color: #ced4da;
            --error-color: #dc3545;
            --header-bg: var(--primary-color);
            --header-text: var(--light-text-color);
            --button-hover-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);

            /* Para uso com rgba() */
            --primary-color-rgb: 0,0,0;
            --error-color-rgb: 220,53,69; /* RGB de #dc3545 */
        }

        /* Estilos base */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background-color: var(--card-background);
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s;
        }

        header {
            background-color: var(--header-bg);
            color: var(--header-text);
            padding: 20px 0;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s, color 0.3s;
        }

        h1, h2 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 20px;
            transition: color 0.3s;
        }

        h1 {
            color: var(--header-text); /* Garante que o H1 no header tenha a cor do texto do header */
        }

        .input-section, .results-section, .settings-section, .edit-section {
            background-color: var(--card-background);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s, border-color 0.3s;
        }

        .file-upload-section, .textarea-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }

        .file-upload-section label {
            font-weight: bold;
            color: var(--primary-dark-color);
        }

        .file-input-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-input {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--background-color);
            color: var(--text-color);
            cursor: pointer;
            transition: border-color 0.3s, background-color 0.3s;
        }

        .file-name {
            font-size: 0.9em;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }

        textarea {
            width: calc(100% - 20px);
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            min-height: 120px;
            resize: vertical;
            font-size: 1em;
            background-color: var(--background-color);
            color: var(--text-color);
            transition: border-color 0.3s, background-color 0.3s, color 0.3s;
        }

        .button-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: var(--light-text-color);
        }

        .btn-primary:hover {
            background-color: var(--primary-dark-color);
            transform: translateY(-2px);
            box-shadow: var(--button-hover-shadow);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: var(--text-color);
        }

        .btn-secondary:hover {
            background-color: var(--secondary-dark-color);
            transform: translateY(-2px);
            box-shadow: var(--button-hover-shadow);
        }

        .btn-danger {
            background-color: var(--accent-color);
            color: var(--light-text-color);
        }

        .btn-danger:hover {
            background-color: #b02a37;
            transform: translateY(-2px);
            box-shadow: var(--button-hover-shadow);
        }

        .results-list, .edit-list {
            list-style: none;
            padding: 0;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--background-color);
            margin-top: 15px;
            transition: background-color 0.3s;
        }

        .results-list li, .edit-list li {
            padding: 10px 15px;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .results-list li:last-child, .edit-list li:last-child {
            border-bottom: none;
        }

        .results-list li:nth-child(even), .edit-list li:nth-child(even) {
            background-color: rgba(0, 0, 0, 0.03); /* Leve listrado */
        }

        .results-count {
            font-weight: bold;
            color: var(--primary-color);
            margin-top: 10px;
            display: block;
            text-align: center;
        }

        .loading-indicator {
            text-align: center;
            padding: 20px;
            font-size: 1.2em;
            color: var(--primary-color);
            display: none; /* Escondido por padrão */
        }

        .error-message {
            color: var(--error-color);
            background-color: rgba(var(--error-color-rgb), 0.1);
            border: 1px solid var(--error-color);
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
            text-align: center;
            font-weight: bold;
            display: none; /* Escondido por padrão */
        }

        .hidden {
            display: none;
        }

        /* Estilos para o filtro de checkboxes dentro da seção de resultados */
        .filter-section {
            margin-bottom: 20px; /* Adiciona um espaço abaixo do filtro */
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--background-color);
            transition: border-color 0.3s, background-color 0.3s;
        }

        .filter-section h2 { /* Estilo para o H2 dentro do filtro */
            margin-top: 0;
            padding-top: 0;
            margin-bottom: 10px;
            font-size: 1.2em; /* Um pouco menor para ser um sub-título */
            text-align: left;
            color: var(--primary-dark-color);
        }

        .filter-section label.filter-label { /* Etiqueta principal do filtro (se usada) */
            font-weight: bold;
            color: var(--primary-dark-color);
            margin-bottom: 10px;
            display: block;
        }

        .scale-checkbox-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px 20px; /* Espaçamento entre os checkboxes */
            padding: 10px 0;
            border-top: 1px solid var(--border-color);
            margin-top: 10px;
        }

        .scale-checkbox-item {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            user-select: none; /* Evita seleção de texto ao clicar */
        }

        .scale-checkbox-item input[type="checkbox"] {
            cursor: pointer;
            transform: scale(1.2); /* Aumenta o tamanho do checkbox */
            margin-right: 5px;
        }

        .scale-checkbox-item span {
            color: var(--text-color);
            font-size: 0.95em;
        }

        .scale-filter-controls {
            display: flex;
            justify-content: flex-start;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .scale-filter-control-item {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }

        .scale-filter-control-item input[type="checkbox"] {
            transform: scale(1.3);
            margin-right: 5px;
            cursor: pointer;
        }
        .scale-filter-control-item label {
            font-weight: bold;
            color: var(--primary-dark-color);
            cursor: pointer;
        }


        /* Seções de configuração de tema */
        .settings-section label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--primary-dark-color);
        }

        .settings-section select,
        .settings-section input[type="color"] {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin-bottom: 10px;
            background-color: var(--background-color);
            color: var(--text-color);
        }

        .custom-theme-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }

        .color-control {
            flex: 1 1 calc(50% - 15px); /* Duas colunas em telas maiores, uma em telas menores */
            min-width: 150px;
        }

        /* Estilos para a navegação por abas */
        .tab-buttons {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap; /* Permite que os botões quebrem linha */
            gap: 5px 0; /* Pequeno espaçamento vertical entre linhas de botões */
        }

        .tab-button {
            padding: 10px 20px;
            cursor: pointer;
            background-color: var(--background-color);
            border: 1px solid var(--border-color);
            border-bottom: none;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            margin-right: 5px;
            font-weight: bold;
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        .tab-button.active {
            background-color: var(--card-background);
            border-color: var(--border-color);
            color: var(--primary-color);
            border-bottom: 1px solid var(--card-background); /* Cobre a borda de baixo */
        }

        .tab-button:hover:not(.active) {
            background-color: rgba(var(--primary-color-rgb), 0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Estilos para a lista de edição de ausentes */
        .edit-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
        }

        .edit-list-item select {
            padding: 5px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            background-color: var(--background-color);
            color: var(--text-color);
            margin-left: 10px;
        }
        
        .edit-list-item button {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background-color: var(--accent-color);
            color: var(--light-text-color);
            margin-left: 10px;
            transition: background-color 0.2s;
        }

        .edit-list-item button:hover {
            background-color: #b02a37;
        }

        .edit-list-item .name-info {
            flex-grow: 1;
        }

        /* Media Queries para responsividade */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                padding: 15px;
            }
            .button-group {
                flex-direction: column;
                gap: 10px;
            }
            .btn {
                width: 100%;
            }
            .file-input-wrapper {
                flex-direction: column;
                align-items: flex-start;
            }
            .file-input, .file-name {
                width: 100%;
                max-width: none;
            }
            .custom-theme-controls .color-control {
                flex: 1 1 100%; /* Uma coluna em telas pequenas */
            }
            .filter-section {
                flex-direction: column;
                align-items: stretch;
            }
            .filter-section label {
                padding-top: 0;
            }
            .scale-checkbox-container {
                flex-direction: column; /* Em telas menores, os checkboxes ficam em coluna */
                align-items: flex-start;
            }
            .scale-filter-controls {
                flex-direction: column;
                gap: 10px;
            }
            .edit-list-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            .edit-list-item select, .edit-list-item button {
                width: 100%;
                margin-left: 0;
            }
            .tab-buttons {
                flex-direction: column;
            }
            .tab-button {
                width: 100%;
                margin-right: 0;
                margin-bottom: 5px;
            }
        }

        /* Temas Adicionais */

        /* Tema Escuro */
        body.theme-dark {
            --primary-color: #BB86FC; /* Roxo claro */
            --primary-dark-color: #3700B3; /* Roxo escuro */
            --secondary-color: #03DAC6; /* Ciano claro */
            --secondary-dark-color: #018786; /* Ciano escuro */
            --accent-color: #CF6679; /* Vermelho claro */
            --text-color: #E0E0E0; /* Texto claro */
            --light-text-color: #121212; /* Texto escuro para contrastar em elementos claros */
            --background-color: #121212;
            --card-background: #1E1E1E;
            --border-color: #303030;
            --error-color: #CF6679;
            --header-bg: #212121;
            --header-text: var(--text-color);
            --primary-color-rgb: 187,134,252;
            --error-color-rgb: 207,102,121;
        }

        /* Tema Azul */
        body.theme-blue {
            --primary-color: #2196F3; /* Azul */
            --primary-dark-color: #1976D2;
            --secondary-color: #FFC107; /* Amarelo */
            --secondary-dark-color: #FFA000;
            --accent-color: #F44336; /* Vermelho */
            --text-color: #212121;
            --light-text-color: #ffffff;
            --background-color: #E3F2FD;
            --card-background: #ffffff;
            --border-color: #90CAF9;
            --error-color: #F44336;
            --header-bg: var(--primary-color);
            --header-text: var(--light-text-color);
            --primary-color-rgb: 33,150,243;
            --error-color-rgb: 244,67,54;
        }

        /* Tema Verde */
        body.theme-green {
            --primary-color: #4CAF50; /* Verde */
            --primary-dark-color: #388E3C;
            --secondary-color: #FFEB3B; /* Amarelo claro */
            --secondary-dark-color: #FBC02D;
            --accent-color: #F44336; /* Vermelho */
            --text-color: #212121;
            --light-text-color: #ffffff;
            --background-color: #E8F5E9;
            --card-background: #ffffff;
            --border-color: #A5D6A7;
            --error-color: #F44336;
            --header-bg: var(--primary-color);
            --header-text: var(--light-text-color);
            --primary-color-rgb: 76,175,80;
            --error-color-rgb: 244,67,54;
        }
    </style>
</head>
<body>
    <header>
        <h1>Conferência do Prontos</h1>
    </header>

    <div class="container">
        <div class="tab-buttons">
            <button class="tab-button active" data-tab="inputSection">Listas</button>
            <button class="tab-button" data-tab="missingResultsSection">Resultados</button>
            <button class="tab-button" data-tab="editSection">Editar Ausentes</button>
            <button class="tab-button" data-tab="settingsTabSection"><i class="fas fa-cog"></i> Configurações do Tema</button>
            <button class="tab-button" id="openVitrineBtn"><i class="fas fa-external-link-alt"></i> Abrir Vitrine</button>
        </div>

        <div id="settingsTabSection" class="tab-content">
            <div class="settings-section">
                <h2><i class="fas fa-cog"></i> Configurações do Tema</h2>
                <label for="themeSelect">Escolha um Tema:</label>
                <select id="themeSelect">
                    <option value="default">Padrão (Preto e Amarelo)</option>
                    <option value="dark">Escuro</option>
                    <option value="blue">Azul</option>
                    <option value="green">Verde</option>
                    <option value="custom">Personalizado</option>
                </select>

                <div id="customThemeControls" class="custom-theme-controls" style="display: none;">
                    <div class="color-control">
                        <label for="customPrimaryColor">Cor Primária:</label>
                        <input type="color" id="customPrimaryColor" value="#000000">
                    </div>
                    <div class="color-control">
                        <label for="customSecondaryColor">Cor Secundária:</label>
                        <input type="color" id="customSecondaryColor" value="#FFD700">
                    </div>
                    <div class="color-control">
                        <label for="customTextColor">Cor do Texto:</label>
                        <input type="color" id="customTextColor" value="#333333">
                    </div>
                    <div class="color-control">
                        <label for="customBackgroundColor">Cor de Fundo:</label>
                        <input type="color" id="customBackgroundColor" value="#f0f0f0">
                    </div>
                    <div class="color-control">
                        <label for="customCardColor">Cor dos Cartões:</label>
                        <input type="color" id="customCardColor" value="#ffffff">
                    </div>
                </div>
            </div>
        </div>

        <div id="inputSection" class="tab-content active">
            <div class="input-section">
                <h2><i class="fas fa-upload"></i> Carregar ou Colar Listas</h2>

                <p class="error-message" id="errorMessage"></p>
                <div class="loading-indicator" id="loadingIndicator">
                    <i class="fas fa-spinner fa-spin"></i> Processando...
                </div>

                <div class="file-upload-section">
                    <h3>Lista Principal de Colaboradores (Ativos)</h3>
                    <label for="file1Input">Carregar Arquivo (CSV, TXT, Excel):</label>
                    <div class="file-input-wrapper">
                        <input type="file" id="file1Input" accept=".csv, .txt, .xlsx, .xls" class="file-input">
                        <span id="file1NameSpan" class="file-name">Nenhum arquivo selecionado</span>
                    </div>
                    <p>Ou cole os nomes abaixo (um por linha):</p>
                    <textarea id="lista1Textarea" placeholder="Cole os nomes da lista principal aqui (um por linha)..."></textarea>
                </div>

                <hr>

                <div class="file-upload-section">
                    <h3>Lista de Colaboradores do Dia / Turno (Presença)</h3>
                    <label for="file2Input">Carregar Arquivo (CSV, TXT, Excel, **ZIP**):</label>
                    <div class="file-input-wrapper">
                        <input type="file" id="file2Input" accept=".csv, .txt, .xlsx, .xls, .zip" class="file-input">
                        <span id="file2NameSpan" class="file-name">Nenhum arquivo selecionado</span>
                    </div>
                    <p>Ou cole os nomes abaixo (um por linha):</p>
                    <textarea id="lista2Textarea" placeholder="Cole os nomes da lista de presença do dia aqui (um por linha)..."></textarea>
                </div>

                <div class="button-group">
                    <button id="compareBtn" class="btn btn-primary"><i class="fas fa-check-double"></i> Comparar Listas</button>
                    <button id="clearBtn" class="btn btn-danger"><i class="fas fa-eraser"></i> Limpar Tudo</button>
                </div>
            </div>
        </div>

        <div id="missingResultsSection" class="tab-content">
            <div class="results-section">
                <h2><i class="fas fa-user-minus"></i> Colaboradores que ainda precisam realizar o teste de prontidão (<span id="missingCountSpan">0</span>)</h2>
                <div class="filter-section">
                    <h2><i class="fas fa-filter"></i> Filtrar por Escala(s)</h2>
                    <div class="scale-filter-controls">
                        <div class="scale-filter-control-item">
                            <input type="checkbox" id="selectAllScalesCheckbox">
                            <label for="selectAllScalesCheckbox">Selecionar Todas as Escalas</label>
                        </div>
                    </div>
                    <div id="scaleCheckboxesContainer" class="scale-checkbox-container">
                        <span style="font-style: italic; color: #888;">Nenhuma escala disponível para filtragem.</span>
                    </div>
                </div>
                <ul id="missingNamesList" class="results-list">
                    <li>Nenhum colaborador ausente encontrado.</li>
                </ul>
                <div class="button-group">
                    <button id="exportMissingExcelBtn" class="btn btn-secondary" style="display:none;"><i class="fas fa-file-excel"></i> Exportar Ausentes (Excel)</button>
                    <button id="exportMissingPdfBtn" class="btn btn-secondary" style="display:none;"><i class="fas fa-file-pdf"></i> Exportar Ausentes (PDF)</button>
                </div>
            </div>
        </div>

        <div id="editSection" class="tab-content">
            <div class="edit-section">
                <h2><i class="fas fa-edit"></i> Editar Lista de Ausentes</h2>
                <p>Remova nomes ou adicione justificativas para os colaboradores ausentes.</p>
                <ul id="editMissingNamesList" class="edit-list">
                    <li>Nenhum colaborador ausente para editar.</li>
                </ul>
                <div class="button-group">
                    <button id="saveEditedListBtn" class="btn btn-primary"><i class="fas fa-save"></i> Salvar Edições</button>
                    <button id="resetEditedListBtn" class="btn btn-secondary"><i class="fas fa-undo-alt"></i> Resetar Edições</button>
                </div>
            </div>
        </div>

    </div>

    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <script>
        // --- Variáveis globais para os elementos do DOM ---
        const file1Input = document.getElementById('file1Input');
        const file2Input = document.getElementById('file2Input');
        const file1NameSpan = document.getElementById('file1NameSpan');
        const file2NameSpan = document.getElementById('file2NameSpan');
        const lista1Textarea = document.getElementById('lista1Textarea');
        const lista2Textarea = document.getElementById('lista2Textarea');
        const compareBtn = document.getElementById('compareBtn');
        const clearBtn = document.getElementById('clearBtn');
        const missingNamesList = document.getElementById('missingNamesList');
        const missingCountSpan = document.getElementById('missingCountSpan');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorMessage = document.getElementById('errorMessage');
        const missingResultsSection = document.getElementById('missingResultsSection');
        const exportMissingExcelBtn = document.getElementById('exportMissingExcelBtn');
        const exportMissingPdfBtn = document.getElementById('exportMissingPdfBtn');
        const openVitrineBtn = document.getElementById('openVitrineBtn'); // Novo botão para a vitrine

        // Elementos relacionados ao filtro de escala para ausentes
        const scaleCheckboxesContainer = document.getElementById('scaleCheckboxesContainer');
        const selectAllScalesCheckbox = document.getElementById('selectAllScalesCheckbox');
        // const clearAllScalesCheckbox = document.getElementById('clearAllScalesCheckbox'); // REMOVIDO: Novo checkbox

        // Elementos para a nova aba de edição
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const editMissingNamesList = document.getElementById('editMissingNamesList');
        const saveEditedListBtn = document.getElementById('saveEditedListBtn');
        const resetEditedListBtn = document.getElementById('resetEditedListBtn');

        // Armazenará a lista principal com nome original, normalizado e escala
        // Ex: [{ originalName: "João Silva", normalizedName: "joao silva", scale: "Manhã" }]
        let mainCollaboratorsData = []; 
        
        // Armazenará os colaboradores ausentes encontrados na comparação (base, sem justificativa/ID)
        // Ex: [{ originalName: "Maria Souza", normalizedName: "maria souza", scale: "Noite" }]
        let absentCollaboratorsData = [];

        // Armazenará a lista de colaboradores ausentes que pode ser editada, incluindo justificativa e ID
        // Ex: [{ originalName: "Maria Souza", normalizedName: "maria souza", scale: "Noite", justification: "", id: "uuid-abc" }]
        let editableAbsentCollaborators = [];

        let uniqueScales = new Set(); // Para popular o filtro de escala

        // Justificativas pré-definidas (o primeiro vazio para "Selecionar Justificativa")
        const justifications = ["", "Atestado Médico", "Não precisa fazer", "Afastado", "Férias", "Outros"];

        // --- Funções Auxiliares ---

        // Normaliza o nome para comparação (remove acentos, caixa baixa, espaços extras)
        function normalizeName(name) {
            return name.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim().replace(/\s+/g, ' ');
        }

        // Compara as duas listas e retorna os nomes ausentes
        function compareLists(list1, list2) {
            const set2 = new Set(list2); // Lista de presença normalizada
            return list1.filter(item => !set2.has(item.normalizedName)); // Filtra itens da lista principal
        }

        // Funções para manipulação de cores (necessárias para o tema personalizado)
        function hexToRgb(hex) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return { r, g, b };
        }

        function rgbToHex(r, g, b) {
            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
        }

        function darkenColor(hex, percent) {
            let { r, g, b } = hexToRgb(hex);
            r = Math.max(0, r - (r * percent / 100));
            g = Math.max(0, g - (g * percent / 100));
            b = Math.max(0, b - (b * percent / 100));
            return rgbToHex(r, g, b);
        }

        function lightenColor(hex, percent) {
            let { r, g, b } = hexToRgb(hex);
            r = Math.min(255, r + (r * percent / 100));
            g = Math.min(255, g + (g * percent / 100));
            b = Math.min(255, b + (b * percent / 100));
            return rgbToHex(r, g, b);
        }

        function getContrastColor(hex) {
            // Calcula o brilho da cor (luminosidade)
            const { r, g, b } = hexToRgb(hex);
            const brightness = (r * 299 + g * 587 + b * 114) / 1000;
            return brightness > 128 ? '#333333' : '#ffffff'; // Retorna preto para claro, branco para escuro
        }

        // --- Funções de Carregamento de Arquivos ---

// Assumindo que estas variáveis globais (ou elementos DOM) estão definidas no seu escopo:
// let mainCollaboratorsData;
// const loadingIndicator = document.getElementById('loadingIndicator'); // Exemplo
// const errorMessage = document.getElementById('errorMessage');       // Exemplo
//
// E a função normalizeName está definida, por exemplo:
// function normalizeName(name) {
//     return name.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
// }

async function processFileData(fileData, fileName, isPrincipalList) {
    let namesForTextarea = [];

    if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
        const data = new Uint8Array(fileData);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];

        if (!isPrincipalList) { // Esta é a Lista de Colaboradores do Dia (Presença)
            const B_COL_INDEX = 1; // Coluna B (índice 1)
            const HEADER_ROW_INDEX = 14; // Linha 15 no Excel (índice 14) para o cabeçalho

            let targetColIndex = -1; // Irá armazenar o índice da coluna "Usuário"
            let dataStartRow = -1;   // Irá armazenar a linha de início dos dados

            // 1. Tenta ler a célula B15 (HEADER_ROW_INDEX, B_COL_INDEX)
            const cellB15Address = XLSX.utils.encode_cell({ r: HEADER_ROW_INDEX, c: B_COL_INDEX });
            const cellB15 = worksheet[cellB15Address];

            if (cellB15 && String(cellB15.v).trim().toLowerCase() === "usuário") {
                // Se B15 é "Usuário", usa B15 como cabeçalho e começa a ler da linha 16 (índice 15)
                targetColIndex = B_COL_INDEX;
                dataStartRow = HEADER_ROW_INDEX + 1;
            } else {
                // Se B15 não é "Usuário", procura a coluna "Usuário" especificamente na LINHA 15
                const range = XLSX.utils.decode_range(worksheet['!ref']);
                let foundHeader = false;

                // Percorre a LINHA 15 (HEADER_ROW_INDEX) para encontrar o cabeçalho "Usuário"
                // Garante que a linha 15 está dentro do range da planilha
                if (HEADER_ROW_INDEX <= range.e.r) {
                    for (let C = range.s.c; C <= range.e.c; ++C) {
                        const cellAddress = XLSX.utils.encode_cell({ r: HEADER_ROW_INDEX, c: C });
                        const cell = worksheet[cellAddress];
                        if (cell && String(cell.v).trim().toLowerCase() === "usuário") {
                            targetColIndex = C; // Encontrou a coluna do cabeçalho "Usuário"
                            dataStartRow = HEADER_ROW_INDEX + 1; // Começa a ler da próxima linha (linha 16)
                            foundHeader = true;
                            break;
                        }
                    }
                }


                if (!foundHeader) {
                    throw new Error("Não foi possível encontrar a coluna 'Usuário' na linha 15 do arquivo Excel de presença.");
                }
            }

            // Agora, com targetColIndex e dataStartRow definidos, lê os nomes
            const range = XLSX.utils.decode_range(worksheet['!ref']); // Re-obtém o range
            for (let R = dataStartRow; R <= range.e.r; ++R) {
                const cellAddress = XLSX.utils.encode_cell({ r: R, c: targetColIndex });
                const cell = worksheet[cellAddress];
                if (cell && cell.v) {
                    namesForTextarea.push(String(cell.v).trim());
                } else if (!cell || !cell.v) {
                    // Se encontrar uma célula vazia, para a leitura (assume fim da lista)
                    break;
                }
            }

            if (namesForTextarea.length === 0) {
                throw new Error("Nenhum nome encontrado na coluna 'Usuário' do arquivo Excel.");
            }

        } else { // Esta é a Lista Principal de Colaboradores (Ativos)
            const sheetData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            mainCollaboratorsData = [];

            if (sheetData.length > 0) {
                sheetData.forEach((row, index) => {
                    // Pula a primeira linha se for o cabeçalho "Colaborador" e "Escala"
                    if (index === 0 && (normalizeName(row[0]) === "colaborador" || normalizeName(row[0]) === "nome") && (normalizeName(row[1]) === "escala")) {
                        return; // Pula esta linha (cabeçalho)
                    }

                    const originalName = row[0] ? String(row[0]).trim() : '';
                    const scale = row[1] ? String(row[1]).trim() : 'N/A';

                    if (originalName) {
                        mainCollaboratorsData.push({
                            originalName: originalName,
                            normalizedName: normalizeName(originalName),
                            scale: scale
                        });
                    }
                });
            }
            // Salva mainCollaboratorsData no LocalStorage
            localStorage.setItem('mainCollaboratorsData', JSON.stringify(mainCollaboratorsData));
            namesForTextarea = mainCollaboratorsData.map(item => item.originalName);
        }

    } else if (fileName.endsWith('.csv') || fileName.endsWith('.txt')) {
        namesForTextarea = fileData.split('\n').map(name => name.trim()).filter(name => name !== '');
        if (isPrincipalList) {
            mainCollaboratorsData = namesForTextarea.map(name => ({ originalName: name, normalizedName: normalizeName(name), scale: 'N/A' }));
            // Salva mainCollaboratorsData no LocalStorage
            localStorage.setItem('mainCollaboratorsData', JSON.stringify(mainCollaboratorsData));
        }
    } else {
        throw new Error("Formato de arquivo não suportado dentro do ZIP. Os tipos suportados são .csv, .txt, .xlsx, .xls.");
    }
    return namesForTextarea;
}

async function handleFileUpload(event, textareaElement, spanElement, localStorageKey, isPrincipalList) {
    const file = event.target.files[0];
    if (!file) {
        return;
    }

    spanElement.textContent = `Carregando ${file.name}...`;
    loadingIndicator.style.display = "block";
    errorMessage.style.display = "none"; // Limpa mensagens de erro anteriores

    try {
        if (file.name.endsWith('.zip')) {
            if (isPrincipalList) {
                throw new Error("A Lista Principal (Ativos) não suporta arquivos ZIP. Por favor, carregue um arquivo CSV, TXT ou Excel diretamente.");
            }

            const zip = await JSZip.loadAsync(file);
            let foundFile = null;

            // Procura pelo primeiro arquivo suportado na raiz do ZIP
            zip.forEach((relativePath, zipEntry) => {
                if (!zipEntry.dir && (relativePath.endsWith('.csv') || relativePath.endsWith('.txt') || relativePath.endsWith('.xlsx') || relativePath.endsWith('.xls'))) {
                    if (!foundFile) { // Pega apenas o primeiro
                        foundFile = zipEntry;
                    }
                }
            });

            if (!foundFile) {
                throw new Error("Nenhum arquivo CSV, TXT ou Excel válido encontrado dentro do arquivo ZIP.");
            }

            let fileContent;
            if (foundFile.name.endsWith('.xlsx') || foundFile.name.endsWith('.xls')) {
                fileContent = await foundFile.async("arraybuffer");
            } else {
                fileContent = await foundFile.async("text");
            }

            const names = await processFileData(fileContent, foundFile.name, isPrincipalList);
            textareaElement.value = names.join('\n');
            spanElement.textContent = `${file.name} (arquivo descompactado: ${foundFile.name})`;
            localStorage.setItem(localStorageKey, names.join('\n'));

        } else {
            const reader = new FileReader();
            reader.onload = async function(e) {
                let fileContent;
                if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    fileContent = e.target.result;
                } else {
                    fileContent = e.target.result;
                }
                const names = await processFileData(fileContent, file.name, isPrincipalList);
                textareaElement.value = names.join('\n');
                spanElement.textContent = file.name;
                localStorage.setItem(localStorageKey, names.join('\n'));
            };

            if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                reader.readAsArrayBuffer(file);
            } else {
                reader.readAsText(file);
            }
        }
    } catch (error) {
        errorMessage.textContent = `Erro ao carregar arquivo: ${error.message}`;
        errorMessage.style.display = "block";
        textareaElement.value = "";
        spanElement.textContent = "Nenhum arquivo selecionado";
        console.error("Erro no upload:", error);
    } finally {
        loadingIndicator.style.display = "none";
    }
}


        // --- Função Principal de Comparação ---
        function startComparison() {
            loadingIndicator.style.display = "block";
            errorMessage.style.display = "none"; // Limpa mensagens de erro anteriores

            setTimeout(() => { // Usar setTimeout para permitir que o indicador de carregamento apareça
                const list2Normalized = lista2Textarea.value.split('\n').map(name => normalizeName(name)).filter(name => name !== '');

                if (mainCollaboratorsData.length === 0 || list2Normalized.length === 0) {
                    errorMessage.textContent = "Uma ou ambas as listas estão vazias. Carregue ou cole os nomes antes de comparar.";
                    errorMessage.style.display = "block";
                    missingResultsSection.style.display = "none"; // Esconde a seção de ausentes
                    loadingIndicator.style.display = "none";
                    return;
                }

                absentCollaboratorsData = compareLists(mainCollaboratorsData, list2Normalized);
                
                // Inicializa a lista editável com os resultados da comparação, adicionando a justificativa e um ID
                // Usar structuredClone para fazer uma cópia profunda, se disponível e necessário.
                // Por enquanto, map com spread operator é suficiente para este caso.
                editableAbsentCollaborators = absentCollaboratorsData.map(item => ({
                    ...item,
                    justification: "",
                    id: crypto.randomUUID() // Atribui um ID único a cada item
                }));
                
                // Recria o conjunto de escalas únicas a partir dos AUSENTES recém-encontrados
                uniqueScales = new Set();
                absentCollaboratorsData.forEach(item => {
                    uniqueScales.add(item.scale);
                });
                populateScaleCheckboxes(); // Popula os checkboxes de escala com as escalas dos ausentes

                displayMissingCollaborators(); // Exibe os ausentes (com filtro se aplicado)
                
                loadingIndicator.style.display = "none";

                // Ativa a aba de resultados automaticamente após a comparação
                showTab('missingResultsSection');
            }, 100); // Pequeno atraso para garantir que o spinner apareça
        }

        // Popula os checkboxes de escalas para os ausentes
        function populateScaleCheckboxes() {
            scaleCheckboxesContainer.innerHTML = ''; // Limpa os checkboxes existentes
            selectAllScalesCheckbox.checked = false; // Desmarca o "Selecionar Todas"
            // clearAllScalesCheckbox.checked = false; // REMOVIDO: Novo checkbox

            if (uniqueScales.size === 0) {
                scaleCheckboxesContainer.innerHTML = '<span style="font-style: italic; color: #888;">Nenhuma escala disponível para filtragem.</span>';
                selectAllScalesCheckbox.disabled = true;
                selectAllScalesCheckbox.parentElement.style.display = 'none'; // Esconde o container "Selecionar Todas"
                // clearAllScalesCheckbox.disabled = true; // REMOVIDO
                // clearAllScalesCheckbox.parentElement.style.display = 'none'; // REMOVIDO
                return;
            }

            selectAllScalesCheckbox.disabled = false;
            selectAllScalesCheckbox.parentElement.style.display = 'flex'; // Mostra o container "Selecionar Todas"
            // clearAllScalesCheckbox.disabled = false; // REMOVIDO
            // clearAllScalesCheckbox.parentElement.style.display = 'flex'; // REMOVIDO

            const sortedScales = Array.from(uniqueScales).sort(); // Ordenar as escalas
            sortedScales.forEach(scale => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'scale-checkbox-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `scale-${scale.replace(/\s/g, '-').replace(/[^\w-]/g, '')}`; // Gera um ID mais seguro
                checkbox.value = scale;
                checkbox.checked = true; // Marca todas as escalas por padrão

                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.textContent = scale;

                itemDiv.appendChild(checkbox);
                itemDiv.appendChild(label);
                scaleCheckboxesContainer.appendChild(itemDiv);

                checkbox.addEventListener('change', () => {
                    displayMissingCollaborators(); // Atualiza a lista de resultados
                    // Se estiver na aba de edição, atualiza-a também
                    if (document.getElementById('editSection').classList.contains('active')) {
                        showTab('editSection'); 
                    }
                    updateSelectAllCheckboxState(); // Atualiza o estado do "Selecionar Todas"
                    // clearAllScalesCheckbox.checked = false; // REMOVIDO: Desmarca "Limpar Seleção" ao mudar individualmente
                });
            });

            // Marca o "Selecionar Todas" se todas as escalas estiverem marcadas inicialmente
            updateSelectAllCheckboxState();
        }

        // Atualiza o estado do checkbox "Selecionar Todas"
        function updateSelectAllCheckboxState() {
            const allScaleCheckboxes = scaleCheckboxesContainer.querySelectorAll('input[type="checkbox"]');
            if (allScaleCheckboxes.length === 0) {
                selectAllScalesCheckbox.checked = false;
                selectAllScalesCheckbox.disabled = true;
                return;
            }
            const allChecked = Array.from(allScaleCheckboxes).every(cb => cb.checked);
            selectAllScalesCheckbox.checked = allChecked;
            selectAllScalesCheckbox.disabled = false;
        }


        // Exibe os colaboradores ausentes (filtrados por escala ou todos)
        function displayMissingCollaborators() {
            const selectedScales = [];
            const allScaleCheckboxes = scaleCheckboxesContainer.querySelectorAll('input[type="checkbox"]');
            
            allScaleCheckboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selectedScales.push(checkbox.value);
                }
            });

            let filteredAbsents = [];
            // Filtra com base na lista EDITÁVEL, que é a fonte da verdade para a exibição
            if (selectedScales.length === 0 || selectAllScalesCheckbox.checked) { // Se nada selecionado, ou "selecionar todos" marcado, mostra tudo
                 filteredAbsents = [...editableAbsentCollaborators];
            } else {
                filteredAbsents = editableAbsentCollaborators.filter(item => selectedScales.includes(item.scale));
            }


            missingNamesList.innerHTML = ''; // Limpa a lista

            if (filteredAbsents.length > 0) {
                filteredAbsents.forEach(item => {
                    const li = document.createElement('li');
                    let textContent = `${item.originalName} (Escala: ${item.scale})`;
                    if (item.justification) {
                        textContent += ` - Justificativa: ${item.justification}`;
                    }
                    li.textContent = textContent;
                    missingNamesList.appendChild(li);
                });
                missingCountSpan.textContent = filteredAbsents.length;
                missingResultsSection.style.display = "block";
                exportMissingExcelBtn.style.display = "inline-block";
                exportMissingPdfBtn.style.display = "inline-block";
            } else {
                const li = document.createElement('li');
                li.textContent = "Nenhum colaborador ausente encontrado para esta seleção.";
                missingNamesList.appendChild(li);
                missingCountSpan.textContent = 0;
                missingResultsSection.style.display = "block"; // Ainda exibe a seção, mas com a mensagem
                exportMissingExcelBtn.style.display = "none"; // Oculta botões se não houver dados
                exportMissingPdfBtn.style.display = "none";
            }

            updateSelectAllCheckboxState(); // Atualiza o estado do "Selecionar Todas"
            // **IMPORTANTE**: Salva a lista FILTRADA e ATUAL para a vitrine
            saveFinalAbsentListToLocalStorage(filteredAbsents);
        }


        // Popula a lista na aba de edição
        function populateEditList(collaboratorsToDisplay) { // Agora aceita a lista a ser exibida
            editMissingNamesList.innerHTML = '';
            if (!collaboratorsToDisplay || collaboratorsToDisplay.length === 0) {
                const li = document.createElement('li');
                li.textContent = 'Nenhum colaborador ausente para editar na seleção atual.';
                editMissingNamesList.appendChild(li);
                saveEditedListBtn.disabled = true;
                resetEditedListBtn.disabled = true;
                return;
            }

            saveEditedListBtn.disabled = false;
            resetEditedListBtn.disabled = false;

            collaboratorsToDisplay.forEach(item => { // Itera sobre a lista filtrada/passada
                const li = document.createElement('li');
                li.className = 'edit-list-item';
                li.dataset.id = item.id; // Armazena o ID único para referência

                const nameInfo = document.createElement('span');
                nameInfo.className = 'name-info';
                nameInfo.textContent = `${item.originalName} (Escala: ${item.scale})`;
                li.appendChild(nameInfo);

                const selectJustification = document.createElement('select');
                justifications.forEach(j => {
                    const option = document.createElement('option');
                    option.value = j;
                    option.textContent = j === "" ? "Selecionar Justificativa" : j;
                    selectJustification.appendChild(option);
                });
                selectJustification.value = item.justification; // Define a justificativa atual
                selectJustification.dataset.id = item.id; // Para identificar qual item foi alterado

                // Listener para a seleção de justificativa (agora remove o item)
                selectJustification.addEventListener('change', (e) => {
                    const itemId = e.target.dataset.id;
                    const justificationValue = e.target.value;

                    // A função de remoção
                    if (justificationValue !== "") { // Apenas remove se uma justificativa real for selecionada
                        const indexInMasterList = editableAbsentCollaborators.findIndex(col => col.id === itemId);
                        if (indexInMasterList !== -1) {
                            editableAbsentCollaborators.splice(indexInMasterList, 1); // Remove o item do array principal
                            alert(`Colaborador ${item.originalName} removido com a justificativa: ${justificationValue}`);
                        }
                        // Re-popula a aba de edição com a visualização filtrada atualizada
                        showTab('editSection'); 
                        // Atualiza a aba de resultados também (isso chamará saveFinalAbsentListToLocalStorage)
                        displayMissingCollaborators(); 
                    }
                });
                li.appendChild(selectJustification);

                const removeButton = document.createElement('button');
                removeButton.textContent = 'Remover';
                removeButton.dataset.id = item.id; // Para identificar qual item foi removido
                removeButton.addEventListener('click', (e) => {
                    const itemIdToRemove = e.target.dataset.id;
                    // Encontra o índice na lista principal (não filtrada)
                    const indexInMasterList = editableAbsentCollaborators.findIndex(col => col.id === itemIdToRemove);
                    if (indexInMasterList !== -1) {
                        editableAbsentCollaborators.splice(indexInMasterList, 1); // Remove o item do array principal
                    }
                    // Re-popula a aba de edição com a visualização filtrada atualizada
                    showTab('editSection'); 
                    // Atualiza a aba de resultados também (isso chamará saveFinalAbsentListToLocalStorage)
                    displayMissingCollaborators(); 
                });
                li.appendChild(removeButton);

                editMissingNamesList.appendChild(li);
            });
        }

        // Salva a lista final de ausentes e a data no LocalStorage para a vitrine
        function saveFinalAbsentListToLocalStorage(list) {
            const dataToSave = {
                names: list,
                timestamp: new Date().toISOString() // Salva a data/hora da atualização
            };
            try {
                localStorage.setItem('finalAbsentList', JSON.stringify(dataToSave));
                console.log("Lista final de ausentes salva no LocalStorage para a vitrine.");
            } catch (e) {
                console.error("Erro ao salvar 'finalAbsentList' no LocalStorage:", e);
                alert("Erro ao salvar a lista de ausentes para a vitrine. Pode ser falta de espaço ou permissão.");
            }
        }

        // Salva as edições e atualiza a lista de resultados
        function saveEditedList() {
            // As alterações já são aplicadas diretamente em editableAbsentCollaborators
            // Basta atualizar a visualização das abas (isso chamará displayMissingCollaborators)
            displayMissingCollaborators(); // Atualiza a aba de resultados e salva para a vitrine
            showTab('editSection'); // Re-carrega a aba de edição com a visualização atualizada
            alert('Edições salvas com sucesso!');
        }

        // Reseta as edições para a lista original de ausentes da última comparação
        function resetEditedList() {
            // Recria editableAbsentCollaborators a partir do absentCollaboratorsData original (com novos IDs)
            editableAbsentCollaborators = absentCollaboratorsData.map(item => ({
                ...item,
                justification: "",
                id: crypto.randomUUID()
            }));
            
            // Re-popula a lista de edição (com filtros aplicados)
            showTab('editSection'); 
            // Atualiza a lista de resultados também (isso chamará saveFinalAbsentListToLocalStorage)
            displayMissingCollaborators(); 
            alert('Edições resetadas.');
        }


        // --- Funções de Exportação ---

        // Exporta a lista de ausentes para PDF
        function exportMissingNamesPdf() {
            try {
                if (typeof window.jspdf === 'undefined' || !window.jspdf.jsPDF) {
                    throw new Error("Biblioteca jsPDF não carregada. Tente recarregar a página.");
                }
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                const currentDate = new Date().toLocaleDateString('pt-BR');
                const currentTime = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                
                const selectedScales = [];
                // Pega os valores dos checkboxes marcados
                scaleCheckboxesContainer.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => selectedScales.push(cb.value));
                
                let selectedScaleText = selectedScales.length === 0 ? "Todas as Escalas" : selectedScales.join(', ');

                const title = `Relatório de Colaboradores que ainda precisam realizar o teste de prontidão - Escala(s): ${selectedScaleText}`;
                const subtitle = `Data da Geração: ${currentDate} ${currentTime}`;


                doc.setFontSize(16);
                doc.text(title, 20, 20);
                doc.setFontSize(10);
                doc.text(subtitle, 20, 27);
                doc.setFontSize(12);

                // Usa a lista filtrada (que é a mesma exibida na aba de resultados)
                const currentDisplayedNames = Array.from(missingNamesList.children)
                                                .map(li => li.textContent)
                                                .filter(n => n.trim() !== "Nenhum colaborador ausente encontrado para esta seleção." && n.trim() !== "");

                let y = 40; // Ajusta a posição inicial após o título e subtítulo
                if (currentDisplayedNames.length === 0) {
                    doc.text("Nenhum colaborador ausente encontrado.", 20, y);
                } else {
                    currentDisplayedNames.forEach(name => {
                        if (y > 280) { // Verifica se precisa de nova página (ajustado para mais espaço)
                            doc.addPage();
                            y = 20;
                        }
                        doc.text(name, 20, y);
                        y += 7; // Espaçamento entre as linhas (ajustado para ser mais compacto)
                    });
                }
                doc.save(`relatorio_ausentes_filtrado_${currentDate.replace(/\//g, '-')}.pdf`);
            } catch (error) {
                errorMessage.textContent = `Erro ao exportar PDF: ${error.message}. Tente novamente ou verifique o console para mais detalhes.`;
                errorMessage.style.display = "block";
                console.error("Erro na exportação de PDF:", error);
            }
        }

        // Exporta a lista de ausentes para Excel
        function exportMissingNamesExcel() {
            try {
                if (typeof XLSX === 'undefined' || !XLSX.utils) {
                    throw new Error("Biblioteca SheetJS/XLSX não carregada. Tente recarregar a página.");
                }
                // Pega as escalas selecionadas
                const selectedScales = [];
                scaleCheckboxesContainer.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => selectedScales.push(cb.value));
                
                let selectedScaleText = selectedScales.length === 0 ? "Todas as Escalas" : selectedScales.join(', ');

                // Filtra a lista editableAbsentCollaborators pelas escalas selecionadas para garantir que a exportação seja consistente com a exibição
                const selectedScalesSet = new Set(selectedScales);
                let filteredForExport;
                if (selectedScales.length === 0 || selectAllScalesCheckbox.checked) {
                    filteredForExport = [...editableAbsentCollaborators];
                } else {
                    filteredForExport = editableAbsentCollaborators.filter(item => selectedScalesSet.has(item.scale));
                }


                const currentDate = new Date().toLocaleDateString('pt-BR');
                const currentTime = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                
                const dataForExcel = [
                    ["Relatório de Colaboradores que ainda precisam realizar o teste de prontidão"],
                    [`Escala(s) Filtrada(s): ${selectedScaleText}`],
                    [`Data da Geração: ${currentDate} ${currentTime}`],
                    [], // Linha em branco para espaçamento
                    ["Nome do Colaborador Ausente", "Escala", "Justificativa"] // Cabeçalhos de coluna atualizados
                ];

                if (filteredForExport.length === 0) {
                    dataForExcel.push(["Nenhum colaborador ausente encontrado.", "", ""]);
                } else {
                    filteredForExport.forEach(item => {
                        dataForExcel.push([item.originalName, item.scale, item.justification || '']);
                    });
                }

                const ws = XLSX.utils.aoa_to_sheet(dataForExcel);
                
                // Ajustar largura das colunas
                const wscols = [
                    {wch: 35}, // Coluna A
                    {wch: 15}, // Coluna B
                    {wch: 30}  // Coluna C
                ];
                ws['!cols'] = wscols;

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Ausentes");
                XLSX.writeFile(wb, `relatorio_ausentes_filtrado_${currentDate.replace(/\//g, '-')}.xlsx`);
            } catch (error) {
                errorMessage.textContent = `Erro ao exportar Excel: ${error.message}. Tente novamente ou verifique o console para mais detalhes.`;
                errorMessage.style.display = "block";
                console.error("Erro na exportação de Excel:", error);
            }
        }

        // --- Funções de Limpeza ---
        function clearLists() {
            file1Input.value = "";
            file2Input.value = "";
            file1NameSpan.textContent = "Nenhum arquivo selecionado";
            file2NameSpan.textContent = "Nenhum arquivo selecionado";
            lista1Textarea.value = "";
            lista2Textarea.value = "";

            // Limpa e esconde a seção de ausentes
            missingNamesList.innerHTML = '<li>Nenhum colaborador ausente encontrado.</li>';
            missingCountSpan.textContent = "0";
            // missingResultsSection.style.display = "none"; // Deixa a aba aberta, mas limpa o conteúdo
            exportMissingExcelBtn.style.display = "none";
            exportMissingPdfBtn.style.display = "none";
            
            // Limpa dados de escalas e filtro
            mainCollaboratorsData = [];
            absentCollaboratorsData = [];
            editableAbsentCollaborators = []; // Limpa a lista editável também
            uniqueScales = new Set();
            populateScaleCheckboxes(); // Reseta o filtro
            populateEditList([]); // Popula a lista de edição passando uma lista vazia
            
            loadingIndicator.style.display = "none";
            errorMessage.style.display = "none"; // Garante que a mensagem de erro seja limpa
            localStorage.removeItem("listaPrincipal");
            localStorage.removeItem("listaDia");
            localStorage.removeItem("mainCollaboratorsData"); // Limpa os dados da lista principal também
            localStorage.removeItem("finalAbsentList"); // **Limpa a lista final para a vitrine**
        }

        // --- Funções de Tema ---
        const themeSelect = document.getElementById('themeSelect');
        const customThemeControls = document.getElementById('customThemeControls');
        const customPrimaryColor = document.getElementById('customPrimaryColor');
        const customSecondaryColor = document.getElementById('customSecondaryColor');
        const customTextColor = document.getElementById('customTextColor');
        const customBackgroundColor = document.getElementById('customBackgroundColor');
        const customCardColor = document.getElementById('customCardColor');
        const root = document.documentElement; // O elemento <html>

        function applyTheme(themeName) {
            document.body.className = ''; // Remove todas as classes de tema existentes
            if (themeName && themeName !== 'default' && themeName !== 'custom') {
                document.body.classList.add(`theme-${themeName}`);
                customThemeControls.style.display = 'none';
                localStorage.setItem('selectedTheme', themeName);
                localStorage.removeItem('customColors'); // Limpa cores personalizadas
                resetToDefaultThemeProperties(); // Assegura que propriedades customizadas sejam resetadas
            } else if (themeName === 'custom') {
                document.body.classList.add('theme-custom'); // Adiciona uma classe custom para CSS se necessário
                customThemeControls.style.display = 'flex';
                loadCustomColors(); // Carrega e aplica as cores personalizadas
                localStorage.setItem('selectedTheme', 'custom');
            } else { // default
                customThemeControls.style.display = 'none';
                resetToDefaultThemeProperties(); // Restaura as propriedades para o padrão
                localStorage.setItem('selectedTheme', 'default');
                localStorage.removeItem('customColors');
            }
            // Garante que o RGB do error-color seja atualizado para o tema atual
            const currentErrorColor = getComputedStyle(document.body).getPropertyValue('--error-color').trim();
            const { r, g, b } = hexToRgb(currentErrorColor.startsWith('#') ? currentErrorColor : '#dc3545'); // fallback se for variável CSS e não hex
            root.style.setProperty('--error-color-rgb', `${r},${g},${b}`);
        }

        // Função para resetar as variáveis CSS para o tema padrão (inicial)
        function resetToDefaultThemeProperties() {
            root.style.setProperty('--primary-color', '#000000');
            root.style.setProperty('--primary-dark-color', '#333333');
            root.style.setProperty('--secondary-color', '#FFD700');
            root.style.setProperty('--secondary-dark-color', '#CCAA00');
            root.style.setProperty('--accent-color', '#DC3545');
            root.style.setProperty('--text-color', '#333');
            root.style.setProperty('--light-text-color', '#ffffff');
            root.style.setProperty('--background-color', '#f0f0f0');
            root.style.setProperty('--card-background', '#ffffff');
            root.style.setProperty('--border-color', '#ced4da');
            root.style.setProperty('--error-color', '#dc3545');
            root.style.setProperty('--header-bg', 'var(--primary-color)');
            root.style.setProperty('--header-text', 'var(--light-text-color)');
            root.style.setProperty('--button-hover-shadow', '0 6px 12px rgba(0, 0, 0, 0.2)');

            // Para que o CSS possa usar as cores rgb para opacidade
            root.style.setProperty('--primary-color-rgb', '0,0,0');
            root.style.setProperty('--error-color-rgb', '220,53,69');
        }

        function applyCustomColors() {
            root.style.setProperty('--primary-color', customPrimaryColor.value);
            root.style.setProperty('--primary-dark-color', darkenColor(customPrimaryColor.value, 20));
            root.style.setProperty('--secondary-color', customSecondaryColor.value);
            root.style.setProperty('--secondary-dark-color', darkenColor(customSecondaryColor.value, 20));
            root.style.setProperty('--text-color', customTextColor.value);
            // light-text-color deve ser a cor que contrasta com o primary-color (para botões/header)
            // e também com o card-background (para texto de contraste em general).
            // Aqui estamos usando o contraste do customPrimaryColor para header/botões.
            root.style.setProperty('--light-text-color', getContrastColor(customPrimaryColor.value)); 
            root.style.setProperty('--background-color', customBackgroundColor.value);
            root.style.setProperty('--card-background', customCardColor.value);
            
            // A cor da borda pode ser baseada na cor do card para um visual mais integrado
            const cardRgb = hexToRgb(customCardColor.value);
            const borderColor = rgbToHex(
                Math.max(0, cardRgb.r - 20),
                Math.max(0, cardRgb.g - 20),
                Math.max(0, cardRgb.b - 20)
            );
            root.style.setProperty('--border-color', borderColor); 

            root.style.setProperty('--header-bg', customPrimaryColor.value);
            root.style.setProperty('--header-text', getContrastColor(customPrimaryColor.value));
            root.style.setProperty('--button-hover-shadow', '0 6px 12px rgba(0, 0, 0, 0.2)');

            // Para que o CSS possa usar as cores rgb para opacidade (ex: rgba(var(--error-color-rgb), 0.1))
            const getRgb = (hex) => {
                const r = parseInt(hex.slice(1, 3), 16);
                const g = parseInt(hex.slice(3, 5), 16);
                const b = parseInt(hex.slice(5, 7), 16);
                return `${r},${g},${b}`;
            };
            root.style.setProperty('--primary-color-rgb', getRgb(customPrimaryColor.value));
            // A cor de erro pode ser fixa, ou adicionada como um input de cor customizável também
            root.style.setProperty('--error-color-rgb', getRgb(document.body.className.includes('theme-') ? getComputedStyle(document.body).getPropertyValue('--error-color') : '#dc3545')); 
            saveCustomColors();
        }

        function saveCustomColors() {
            const customColors = {
                primary: customPrimaryColor.value,
                secondary: customSecondaryColor.value,
                text: customTextColor.value,
                background: customBackgroundColor.value,
                card: customCardColor.value
            };
            localStorage.setItem('customColors', JSON.stringify(customColors));
        }

        function loadCustomColors() {
            const savedColors = localStorage.getItem('customColors');
            if (savedColors) {
                const colors = JSON.parse(savedColors);
                customPrimaryColor.value = colors.primary;
                customSecondaryColor.value = colors.secondary;
                customTextColor.value = colors.text;
                customBackgroundColor.value = colors.background;
                customCardColor.value = colors.card;
            } else {
                // Define valores padrão para o tema personalizado (preto e amarelo) se não houver cores salvas
                customPrimaryColor.value = "#000000";
                customSecondaryColor.value = "#FFD700";
                customTextColor.value = "#333333";
                customBackgroundColor.value = "#f0f0f0";
                customCardColor.value = "#ffffff";
            }
            applyCustomColors(); // Aplica as cores carregadas/padrão
        }

        // --- Funções de Abas (Tabs) ---
        function showTab(tabId) {
            tabContents.forEach(content => {
                content.classList.remove('active');
            });
            tabButtons.forEach(button => {
                button.classList.remove('active');
            });

            // Adiciona a classe 'active' ao botão da aba clicada, exceto se for o botão "Abrir Vitrine"
            if (tabId !== 'openVitrineBtn') {
                document.getElementById(tabId).classList.add('active');
                document.querySelector(`.tab-button[data-tab="${tabId}"]`).classList.add('active');
            }
            

            // Quando a aba de edição é mostrada, populamos a lista de edição com base nos filtros atuais
            if (tabId === 'editSection') {
                const selectedScales = [];
                const allScaleCheckboxes = scaleCheckboxesContainer.querySelectorAll('input[type="checkbox"]');
                allScaleCheckboxes.forEach(checkbox => {
                    if (checkbox.checked) {
                        selectedScales.push(checkbox.value);
                    }
                });

                let filteredForEdit = [];
                if (selectedScales.length === 0 || selectAllScalesCheckbox.checked) {
                    filteredForEdit = [...editableAbsentCollaborators];
                } else {
                    filteredForEdit = editableAbsentCollaborators.filter(item => selectedScales.includes(item.scale));
                }
                populateEditList(filteredForEdit);
            } else if (tabId === 'missingResultsSection') {
                // Garante que os resultados estejam sempre atualizados ao trocar para esta aba
                displayMissingCollaborators();
            }
        }


        // --- Event Listeners e carregamento inicial ---

        window.addEventListener("load", () => {
            const saved1 = localStorage.getItem("listaPrincipal"); // Texto puro
            const saved2 = localStorage.getItem("listaDia"); // Texto puro
            const savedMainData = localStorage.getItem("mainCollaboratorsData"); // Dados estruturados com escalas

            if (savedMainData) {
                try {
                    mainCollaboratorsData = JSON.parse(savedMainData);
                    lista1Textarea.value = mainCollaboratorsData.map(item => item.originalName).join('\n');
                    file1NameSpan.textContent = "Dados da lista principal restaurados do cache";
                    // Recria as escalas únicas e popula os checkboxes se já houver dados
                    uniqueScales = new Set(mainCollaboratorsData.map(item => item.scale));
                    populateScaleCheckboxes();
                } catch (e) {
                    console.error("Erro ao carregar mainCollaboratorsData do LocalStorage:", e);
                    localStorage.removeItem("mainCollaboratorsData"); // Limpa dados corrompidos
                    // Fallback para carregar como texto simples se o JSON estiver corrompido
                    if (saved1) {
                        lista1Textarea.value = saved1;
                        file1NameSpan.textContent = "Conteúdo colado na caixa de texto";
                        mainCollaboratorsData = saved1.split('\n')
                            .map(name => name.trim())
                            .filter(name => name !== '')
                            .map(name => ({
                                originalName: name,
                                normalizedName: normalizeName(name),
                                scale: 'N/A' 
                            }));
                        uniqueScales = new Set(mainCollaboratorsData.map(item => item.scale));
                        populateScaleCheckboxes();
                    }
                }
            } else if (saved1) { // Se não tem mainCollaboratorsData, mas tem o texto puro
                lista1Textarea.value = saved1;
                file1NameSpan.textContent = "Conteúdo colado na caixa de texto";
                mainCollaboratorsData = saved1.split('\n')
                    .map(name => name.trim())
                    .filter(name => name !== '')
                    .map(name => ({
                        originalName: name,
                        normalizedName: normalizeName(name),
                        scale: 'N/A' // Se veio do localStorage como texto, não tem info de escala
                    }));
                uniqueScales = new Set(mainCollaboratorsData.map(item => item.scale));
                populateScaleCheckboxes();
            }

            if (saved2) {
                lista2Textarea.value = saved2;
                file2NameSpan.textContent = "Conteúdo colado na caixa de texto";
            }

            // Garante que as seções de resultado estejam ocultas inicialmente
            // missingResultsSection.style.display = "none"; // Não precisa esconder a section inteira, só os botões
            exportMissingExcelBtn.style.display = "none";
            exportMissingPdfBtn.style.display = "none";
            populateScaleCheckboxes(); // Popula os checkboxes (pode ser com N/A se vier do texto)
            populateEditList([]); // Popula a lista de edição (inicialmente vazia, ou com filtro)

            // Aplicar tema salvo ou padrão
            const savedTheme = localStorage.getItem('selectedTheme') || 'default';
            themeSelect.value = savedTheme;
            applyTheme(savedTheme);
            if (savedTheme === 'custom') {
                loadCustomColors();
            }

            // Exibir a aba inicial (Listas)
            showTab('inputSection');
        });

        // Event Listeners para inputs de arquivo
        file1Input.addEventListener("change", e => handleFileUpload(e, lista1Textarea, file1NameSpan, 'listaPrincipal', true)); // true para isPrincipalList
        file2Input.addEventListener("change", e => handleFileUpload(e, lista2Textarea, file2NameSpan, 'listaDia', false));

        // Event Listeners para botões
        compareBtn.addEventListener("click", startComparison);
        clearBtn.addEventListener("click", clearLists);
        saveEditedListBtn.addEventListener("click", saveEditedList);
        resetEditedListBtn.addEventListener("click", resetEditedList);
        openVitrineBtn.addEventListener("click", () => {
            window.open('vitrine.html', '_blank');
        });

        // Event Listeners para exportação da seção de ausentes
        exportMissingExcelBtn.addEventListener("click", exportMissingNamesExcel);
        exportMissingPdfBtn.addEventListener("click", exportMissingNamesPdf);

        // Event Listeners para textareas (colar conteúdo)
        lista1Textarea.addEventListener("input", e => {
            localStorage.setItem("listaPrincipal", e.target.value);
            file1NameSpan.textContent = e.target.value.trim() ? "Conteúdo colado na caixa de texto" : "Nenhum arquivo selecionado";
            file1Input.value = ""; // Limpa o input file se houver conteúdo colado

            // Se a lista principal é modificada via texto, os dados de escala são perdidos.
            const namesFromTextarea = e.target.value.split('\n').map(name => name.trim()).filter(name => name !== '');
            mainCollaboratorsData = namesFromTextarea.map(name => ({ originalName: name, normalizedName: normalizeName(name), scale: 'N/A' }));
            localStorage.setItem('mainCollaboratorsData', JSON.stringify(mainCollaboratorsData)); // Salva com "N/A"
            
            // Atualiza escalas únicas para o filtro
            uniqueScales = new Set(mainCollaboratorsData.map(item => item.scale));
            populateScaleCheckboxes();
        });

        lista2Textarea.addEventListener("input", e => {
            localStorage.setItem("listaDia", e.target.value);
            file2NameSpan.textContent = e.target.value.trim() ? "Conteúdo colado na caixa de texto" : "Nenhum arquivo selecionado";
            file2Input.value = ""; // Limpa o input file se houver conteúdo colado
        });

        // Event Listener para o checkbox "Selecionar Todas as Escalas"
        selectAllScalesCheckbox.addEventListener('change', (e) => {
            const isChecked = e.target.checked;
            const allScaleCheckboxes = scaleCheckboxesContainer.querySelectorAll('input[type="checkbox"]');
            allScaleCheckboxes.forEach(checkbox => {
                checkbox.checked = isChecked;
            });
            displayMissingCollaborators(); // Atualiza a lista de resultados (e salva para vitrine)
            // Se estiver na aba de edição, atualiza-a também para refletir a nova seleção de filtros
            if (document.getElementById('editSection').classList.contains('active')) {
                showTab('editSection'); 
            }
            // clearAllScalesCheckbox.checked = false; // REMOVIDO: Desmarca "Limpar Seleção" ao usar "Selecionar Todas"
        });

        // REMOVIDO: Event Listener para o checkbox "Limpar Seleção de Escalas"
        // clearAllScalesCheckbox.addEventListener('change', (e) => {
        //     const isChecked = e.target.checked;
        //     const allScaleCheckboxes = scaleCheckboxesContainer.querySelectorAll('input[type="checkbox"]');
        //     allScaleCheckboxes.forEach(checkbox => {
        //         checkbox.checked = !isChecked; // Desmarca se "Limpar Seleção" for marcado
        //     });
        //     displayMissingCollaborators(); // Atualiza a lista de resultados (e salva para vitrine)
        //     if (document.getElementById('editSection').classList.contains('active')) {
        //         showTab('editSection'); 
        //     }
        //     if (isChecked) { // Se marcou "Limpar Seleção", desmarca "Selecionar Todas"
        //         selectAllScalesCheckbox.checked = false;
        //     }
        // });

        // Event Listeners para tema
        themeSelect.addEventListener('change', (e) => applyTheme(e.target.value));
        customPrimaryColor.addEventListener('input', applyCustomColors);
        customSecondaryColor.addEventListener('input', applyCustomColors);
        customTextColor.addEventListener('input', applyCustomColors);
        customBackgroundColor.addEventListener('input', applyCustomColors);
        customCardColor.addEventListener('input', applyCustomColors);

        // Event Listeners para os botões de aba
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const tabId = button.dataset.tab;
                if (tabId) { // Garante que não seja o botão "Abrir Vitrine"
                    showTab(tabId);
                }
            });
        });

    </script>
</body>
</html>